# 12. 性能诊断与排障

## 知识点详解

### 12.1 常用工具
jstack用于线程栈分析，定位死锁和热点；jmap用于heap dump与对象统计；jstat用于GC与内存趋势监控；VisualVM提供可视化分析；JFR可低开销记录运行时事件。合理组合工具是诊断效率的关键。

### 12.2 CPU飙高、内存泄漏、死锁定位流程
CPU飙高通常先用top定位进程，再用jstack或采样工具找到热点线程与方法；内存泄漏通过heap dump分析对象占用与引用链；死锁可直接通过jstack检测到“Found one Java-level deadlock”。

### 12.3 性能优化思路
优化优先从减少对象创建、批量处理、缓存命中率提升入手，再考虑算法和并发模型调整。任何优化都应以指标验证为前提，避免“优化幻觉”。

## 面试点与参考回答

### Q1 如何定位线上CPU 100%
先用系统工具定位高CPU线程，记录线程ID并转换为十六进制，再通过jstack查找对应线程栈，定位热点方法与调用路径，必要时结合采样或火焰图。

### Q2 如何排查死锁
通过jstack或jcmd获取线程dump，检查是否有互相等待的锁；确认锁顺序、持有时间和等待条件，调整锁顺序或引入超时机制。

## 掌握评估

### 自测1 能给出排障步骤与示例命令
写出CPU飙高排查步骤，包括top、jstack、jcmd、jfr等命令，并说明各步骤的目的。

### 自测2 能结合监控指标做性能分析
解释如何用QPS、延迟分位数、GC停顿、CPU与内存利用率判断性能瓶颈所在层级。
