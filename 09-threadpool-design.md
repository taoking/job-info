# 9. 线程池与并发设计

## 知识点详解

### 9.1 ThreadPoolExecutor参数
核心线程数决定常驻线程数量；最大线程数是高峰上限；阻塞队列决定任务堆积策略；拒绝策略定义无法接收任务时的处理方式；线程工厂用于命名与设置线程属性。参数组合决定了吞吐、延迟和资源占用的平衡。

常见思路是：CPU密集型线程数接近核心数，IO密集型可适当放大；队列优先考虑有界队列避免OOM；拒绝策略结合业务选择抛异常、丢弃、丢弃最老或由调用方执行。

### 9.2 线程池类型
Fixed线程池使用无界队列，线程数固定，容易在任务堆积时OOM；Cached线程池使用SynchronousQueue，线程数可膨胀到很大，适合短任务但容易引发线程过多；Scheduled线程池用于延时与周期任务，但任务执行时间过长会造成堆积和漂移。

### 9.3 任务堆积与线程泄漏
任务堆积通常表现为队列长度持续上升、响应时间变长、拒绝次数增加。原因可能是上游请求突增、下游依赖慢、线程被阻塞或死锁。线程泄漏多发生在任务不结束、阻塞等待、或未正确释放资源时。

### 9.4 并发设计模式
读写锁适合读多写少场景，提升并发度；无锁设计通过CAS减少阻塞但要注意自旋开销；限流用于保护系统在高峰时保持稳定；熔断用于在依赖故障时快速失败并自我恢复。

## 面试点与参考回答

### Q1 如何根据业务场景设置线程池参数
先判断是CPU密集还是IO密集，估算线程数范围；根据任务耗时与QPS设定队列容量；选择有界队列并配合拒绝策略与监控报警；通过压测与线上指标迭代参数，而不是一次性定死。

### Q2 线程池常见OOM与排查
常见OOM原因包括无界队列堆积、大量线程导致本地内存耗尽、任务对象过大。排查可结合队列长度、活跃线程、堆转储和GC日志判断堆积与内存使用来源。

## 掌握评估

### 自测1 能写出线程池配置并说明理由
给定一个IO密集场景，写出线程池参数并解释核心线程数、最大线程数、队列容量与拒绝策略的选择逻辑。

### 自测2 能结合监控指标判断线程池状态
说明如何通过活跃线程数、队列长度、拒绝次数、任务耗时分位数判断是否需要扩容或降级。
